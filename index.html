<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <title>Indigo demo</title>
    <script src="https://code.jquery.com/jquery-1.11.3.min.js"></script>
    <script src="libindigo.js"></script>

<script>
function loadIndigo()
{
	return new Promise(function(resolve, reject)
	{

	  Module.onRuntimeInitialized = async _ => {
	    const api = {
	      version: Module.cwrap('indigoVersion', 'string', [])
	    };
	    return resolve(api.version());
	  };

	  Module.onAbort = async _ => {
		reject(Error('There was a network error.'));
	  };
	});
}

  function LoadFile(url) {
    // Create new promise with the Promise() constructor;
    // This has as its argument a function
    // with two parameters, resolve and reject
    return new Promise(function(resolve, reject) {
      // Standard XHR to load an file
      var request = new XMLHttpRequest();
      request.open('GET', url);
      request.responseType = 'arraybuffer';
      // When the request loads, check whether it was successful
      request.onload = function() {
        if (request.status === 200) {
        // If successful, resolve the promise by passing back the request response
          resolve(request.response);
        } else {
        // If it fails, reject the promise with a error message
          reject(Error('File didn\'t load successfully; error code:' + request.statusText));
        }
      };
      request.onerror = function() {
      // Also deal with the case when the entire request fails to begin with
      // This is probably a network error, so reject the promise with an appropriate message
          reject(Error('There was a network error.'));
      };
      // Send the request
      request.send();
    });
  }

/*
function testFingerprints ()
{

   int mol = indigoLoadMoleculeFromString("C1C=CC=CC=1N(C)CO");
   int qmol = indigoLoadQueryMoleculeFromString("C1C=CC=CC=1N(C)CO");
   int fp = indigoFingerprint(mol, "sub-res");
   int qfp = indigoFingerprint(qmol, "sub-res");
   char *buf;
   int bufsize;

   printf("%s\n", indigoToString(fp));
   printf("%s\n", indigoToString(qfp));
   indigoToBuffer(fp, &buf, &bufsize);
   printf("size=%d\n", bufsize);
}
*/
</script>

    <script type="text/javascript">
      $( window ).on( "load", async function() {

	   var result = await loadIndigo();
           $("div.version").text(result);
           var m = 'c1ccccc1N';
           $("div.mol").text(m);
           var mol = Module.ccall('indigoLoadMoleculeFromString', 'number', ['string'], [m]);
           var w = Module.ccall('indigoMolecularWeight', 'number', ['number'], [mol]);
           $("div.mass").text(w);
           var molfile = Module.ccall('indigoMolfile', 'string', ['number'], [mol]);
           $("div.molfile").text(molfile);
//	   Module.ccall('indigoSetOption', null, ['string', 'string'], ['render-output-format', 'png']);
//	   Module.ccall('indigoRenderToFile', null, ['number', 'string'], [mol,'query1.png']);


           const indigo = {
	      LoadMolecule: Module.cwrap('indigoLoadMoleculeFromString', 'number', ['string']),
	      LoadQueryMolecule: Module.cwrap('indigoLoadQueryMoleculeFromString', 'number', ['string']),
              Fingerprint: Module.cwrap('indigoFingerprint', 'number', ['number','string']),
              Molfile: Module.cwrap('indigoMolfile','string', ['number']),
	      ToString:	Module.cwrap('indigoToString','string', ['number']),
	      CountBits: Module.cwrap('indigoCountBits','number', ['number']),
	      CommonBits: Module.cwrap('indigoCommonBits','number', ['number','number']),
	      Similarity: Module.cwrap('indigoSimilarity','number', ['number','number','string'])
	    };

	//testFingerprints 

	var mol = indigo.LoadMolecule("C1C=CC=CC=1N(C)CO");
	console.log(mol);
	var qmol = indigo.LoadQueryMolecule("C1C=CC=CC=1N(C)CO");
	console.log(qmol);
	var fp = indigo.Fingerprint(mol, "sub-res");
	console.log(fp);
	var qfp = indigo.Fingerprint(qmol, "sub-res");
	console.log(qfp);
	console.log(indigo.ToString(fp));
	console.log(indigo.ToString(qfp));
        $("div.t1").text(indigo.ToString(fp));
        $("div.t2").text(indigo.ToString(qfp));

	// testSimilarity 
/*
void testSimilarity (void)
{
   int mol1 = indigoLoadMoleculeFromString("C1C=CC=CC=1NO");
   int mol2 = indigoLoadMoleculeFromString("C1C=CC=CC=1NP");

   int fp1 = indigoFingerprint(mol1, "sub");
   int fp2 = indigoFingerprint(mol2, "sub");

   printf("ones1=%d, ones2=%d, ones_common=%d\n", 
           indigoCountBits(fp1), indigoCountBits(fp2),
           indigoCommonBits(fp1, fp2));

   printf("%f\n", indigoSimilarity(mol1, mol2, 0));
   printf("%f\n", indigoSimilarity(fp1, fp2, "tversky"));
}
*/
   var mol1 = indigo.LoadMolecule("C1C=CC=CC=1NO");
   var mol2 = indigo.LoadMolecule("C1C=CC=CC=1NP");

   var fp1 = indigo.Fingerprint(mol1, "sub");
   var fp2 = indigo.Fingerprint(mol2, "sub");

   $("div.ts1").text('ones1=' + indigo.CountBits(fp1) +', ones2=' + indigo.CountBits(fp2) + ', ones_common=' + indigo.CommonBits(fp1, fp2));
   $("div.ts2").text(indigo.Similarity(mol1, mol2, 0));
   $("div.ts3").text(indigo.Similarity(fp1, fp2, "tversky"));


  LoadFile('r1-2ap.mol').then(function(response) {
    // The first runs when the promise resolves, with the request.response
    // specified within the resolve() method.
 //   var fileURL = window.URL.createObjectURL(response);
    console.log('file url' + response.toString());

    // The second runs when the promise
    // is rejected, and logs the Error specified with the reject() method.
  }, function(Error) {
    console.log(Error);
  });

      });
    </script>
  </head>

  <body>
    <h1>Indigo example</h1>
    <h2>Version</h2>
    <div class="version"></div>
    <h2>Molecule</h2>
    <div class="mol"></div>
    <h2>Molecule mass</h2>
    <div class="mass"></div>
    <h2>Molecule file</h2>
    <div class="molfile"></div>
    <h2>Test Fingerprints</h2>
    <div class="t1"></div>
    <div class="t2"></div>
    <h2>Test Similarity</h2>
    <div class="ts1"></div>
    <div class="ts2"></div>
    <div class="ts3"></div>
  </body>
</html>
